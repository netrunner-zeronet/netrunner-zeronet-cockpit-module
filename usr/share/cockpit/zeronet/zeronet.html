<head>
    <title>Pinger</title>
    <meta charset="utf-8">
    <link href="../base1/cockpit.css" type="text/css" rel="stylesheet">
    <script src="../base1/jquery.js"></script>
    <script src="../base1/cockpit.js"></script>
</head>
<body>
    <div class="container-fluid" style='max-width: 400px'>
        <table class="cockpit-form-table">
            <tr>
                <td><label class="control-label" for="status">Status:</label></td>
                <td><label class="control-label" id="stat"></td>
            </tr>
            <tr>
                <td><button class="btn btn-default btn-primary" id="start">Start</button></td>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td><button class="btn btn-default btn-primary" id="open">Open Zeronet</button></td>
            </tr>
        </table>
        <p>
	    <pre id="output"></pre>
        </p>
    </div>

    <script>
        var output = $("#output");
        var stat = $("#stat");
        var btn = $("#start");
        var openBtn = $("#open");
        var isRunning = false;
        
        var SYSTEMD_BUSNAME = "org.freedesktop.systemd1"
        
        var systemd_client = cockpit.dbus(SYSTEMD_BUSNAME, { superuser: "try" });
        var systemd_manager = systemd_client.proxy("org.freedesktop.systemd1.Manager",
                                               "/org/freedesktop/systemd1"); 
        
        function checkStatus() {
            //var proc2 = cockpit.spawn(["zeronet-startstop.sh", "-status"]);
            //proc2.done(status_success);
            //proc2.fail(status_fail);
            var unit;
            systemd_manager.call("GetUnit", [ "zeronet.service" ]).
            done(function (result) {
                console.log(result[0]);
                unit = result
                systemd_client.call(unit[0], "org.freedesktop.DBus.Properties", "Get", [ "org.freedesktop.systemd1.Unit", "SubState" ]).
                done(function (result) {
                        var state = result[0].v;
                        console.log("Zeronet Service subState: " + state);
                        if (state == "running") {
                            isRunning = true;
                            status_success();
                        }
                        else {
                            isRunning = false;
                            status_fail();
                        }
                }).
                fail(function (error) {
                        console.log(error)
                });
            });
            
        }
        
        checkStatus();

        $("#start").on("click", zeronet_run);
        $("#open").on("click", open_zeronet);

        function zeronet_run() {
            //var proc = cockpit.spawn(["zeronet-startstop.sh"]);
            //proc.done(zeronet_success);
            //proc.stream(zeronet_output);
            //proc.fail(zeronet_fail);
            stat.empty();
            output.empty();
            if (!isRunning) {
                systemd_manager.call("StartUnit", [ "zeronet.service", "replace" ]). 
                done(function (result) {
	            console.log("Zeronet.service start: " + result);
	            zeronet_output(result);
	            zeronet_success();
                }).
                fail(function (error) {
	            console.log(error);
	            zeronet_fail();
	            // Maybe some other error message that indicates that the service is not installed
                });
            }
            else {
                systemd_manager.call("StopUnit", [ "zeronet.service", "replace" ]). 
                done(function (result) {
	            console.log("Zeronet.service stop: " + result);
	            zeronet_output(result);
	            zeronet_success();
                }).
                fail(function (error) {
	            console.log(error);
	            zeronet_fail();
	            // Maybe some other error message that indicates that the service is not installed
                });
            }
        }
        
        function open_zeronet() {
            var proc = cockpit.spawn(["hostname"]);
            proc.done(hostname_success);
        }
        
        function hostname_success(data) {
            window.open("http://" + data);
        }

        function zeronet_success() {
            stat.css("color", "green");
            stat.text("checking...");
            checkStatus();
        }

        function zeronet_fail() {
            stat.css("color", "red");
            stat.text("not running");
            checkStatus();
        }
        
        function status_success() {
            stat.css("color", "green");
            stat.text("running");
            btn.text("Stop");
            openBtn.show();
        }

        function status_fail() {
            stat.css("color", "red");
            stat.text("not running");
            btn.text("Start");
            openBtn.hide();
        }

        function zeronet_output(data) {
            output.append(document.createTextNode(data));
            checkStatus();
        }
    </script>
</body>
</html>

